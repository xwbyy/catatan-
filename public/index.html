<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RyLac AI Chat</title>
    <style>
        :root {
            --primary-color: #007AFF;
            --secondary-color: #34C759;
            --background-color: #F2F2F7;
            --card-color: rgba(255, 255, 255, 0.8);
            --text-color: #1C1C1E;
            --subtext-color: #8E8E93;
            --border-color: rgba(0, 0, 0, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --user-message-bg: #007AFF;
            --bot-message-bg: #E5E5EA;
            --user-text-color: white;
            --bot-text-color: black;
            --wallpaper-opacity: 0.1;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --background-color: #1C1C1E;
                --card-color: rgba(44, 44, 46, 0.8);
                --text-color: #F2F2F7;
                --subtext-color: #8E8E93;
                --border-color: rgba(255, 255, 255, 0.1);
                --shadow-color: rgba(0, 0, 0, 0.3);
                --bot-message-bg: #2C2C2E;
                --user-text-color: white;
                --bot-text-color: white;
                --wallpaper-opacity: 0.05;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s ease;
            position: relative;
        }

        .wallpaper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://files.catbox.moe/ie1cd5.jpg');
            background-size: cover;
            background-position: center;
            opacity: var(--wallpaper-opacity);
            z-index: -1;
            transition: opacity 0.3s ease;
        }

        .no-wallpaper .wallpaper {
            display: none;
        }

        .header {
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--card-color);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            z-index: 100;
            position: relative;
        }

        .header-title {
            font-weight: 600;
            font-size: 18px;
        }

        .header-buttons {
            display: flex;
            gap: 12px;
        }

        .icon-button {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .icon-button:hover {
            background-color: rgba(0, 122, 255, 0.1);
        }

        .icon-button i {
            font-size: 18px;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            scroll-behavior: smooth;
            padding-bottom: 80px;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            animation: fadeIn 0.3s ease;
            word-wrap: break-word;
            line-height: 1.4;
            position: relative;
            box-shadow: 0 1px 2px var(--shadow-color);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            align-self: flex-end;
            background-color: var(--user-message-bg);
            color: var(--user-text-color);
            border-bottom-right-radius: 4px;
        }

        .bot-message {
            align-self: flex-start;
            background-color: var(--bot-message-bg);
            color: var(--bot-text-color);
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 11px;
            color: var(--subtext-color);
            margin-top: 4px;
            text-align: right;
        }

        .bot-message .message-time {
            color: var(--subtext-color);
        }

        .input-area {
            padding: 12px 16px;
            background-color: var(--card-color);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-color);
            z-index: 100;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        .input-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            border-radius: 20px;
            border: none;
            background-color: var(--bot-message-bg);
            color: var(--text-color);
            font-size: 16px;
            outline: none;
            resize: none;
            max-height: 120px;
            transition: background-color 0.3s ease;
        }

        .send-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }

        .send-button:active {
            transform: scale(0.95);
        }

        .send-button i {
            font-size: 20px;
        }

        .send-button:disabled {
            background-color: var(--subtext-color);
            cursor: not-allowed;
        }

        .model-selector {
            position: fixed;
            bottom: 80px;
            right: 16px;
            background-color: var(--card-color);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 12px;
            padding: 8px 0;
            box-shadow: 0 4px 12px var(--shadow-color);
            z-index: 1000;
            transform-origin: bottom right;
            transform: scale(0);
            opacity: 0;
            transition: transform 0.2s ease, opacity 0.2s ease;
            border: 1px solid var(--border-color);
        }

        .model-selector.show {
            transform: scale(1);
            opacity: 1;
        }

        .model-option {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .model-option:hover {
            background-color: rgba(0, 122, 255, 0.1);
        }

        .model-option i {
            color: var(--primary-color);
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100%;
            background-color: var(--card-color);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: -2px 0 10px var(--shadow-color);
            z-index: 1000;
            transition: transform 0.3s ease;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar.open {
            transform: translateX(-300px);
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .sidebar-title {
            font-size: 20px;
            font-weight: 600;
        }

        .close-sidebar {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            cursor: pointer;
        }

        .sidebar-section {
            margin-bottom: 20px;
        }

        .sidebar-section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .sidebar-link {
            display: block;
            padding: 10px 0;
            color: var(--text-color);
            text-decoration: none;
            border-bottom: 1px solid var(--border-color);
            transition: color 0.2s ease;
        }

        .sidebar-link:hover {
            color: var(--primary-color);
        }

        .donate-button {
            display: inline-block;
            padding: 10px 15px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 8px;
            text-decoration: none;
            text-align: center;
            margin-top: 10px;
            transition: background-color 0.2s ease;
        }

        .donate-button:hover {
            background-color: #0062CC;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background-color: var(--bot-message-bg);
            border-radius: 18px;
            align-self: flex-start;
            margin-bottom: 12px;
            border-bottom-left-radius: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: var(--subtext-color);
            border-radius: 50%;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        .chat-controls {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            align-items: center;
        }

        .chat-action-button {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        .chat-action-button:hover {
            background-color: rgba(0, 122, 255, 0.1);
        }

        .chat-action-button i {
            font-size: 16px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-label {
            font-size: 14px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .slider-seekbar {
            width: 100%;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--border-color);
            outline: none;
            border-radius: 2px;
            margin-top: 8px;
        }

        .slider-seekbar::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }

        @media (max-width: 600px) {
            .message {
                max-width: 90%;
            }
            
            .sidebar {
                width: 100%;
                right: -100%;
            }
            
            .sidebar.open {
                transform: translateX(-100%);
            }
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            display: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .sending .spinner {
            display: block;
        }

        .sending .send-icon {
            display: none;
        }

        .audio-player {
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--subtext-color);
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="wallpaper"></div>
    
    <div class="header">
        <div class="header-title">RyLac AI</div>
        <div class="header-buttons">
            <button class="icon-button" id="menuButton">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </div>

    <div class="chat-container" id="chatContainer">
        <div class="empty-state">Mulai percakapan baru dengan RyLac AI</div>
    </div>

    <div class="input-area">
        <div class="chat-controls">
            <button class="chat-action-button" id="newChatButton">
                <i class="fas fa-plus"></i> Chat Baru
            </button>
            <button class="chat-action-button" id="modelButton">
                <i class="fas fa-robot"></i> Ganti Model
            </button>
        </div>
        <div class="input-container">
            <textarea class="message-input" id="messageInput" placeholder="Tulis pesan..." rows="1"></textarea>
            <button class="send-button" id="sendButton" disabled>
                <i class="fas fa-paper-plane send-icon"></i>
                <div class="spinner"></div>
            </button>
        </div>
    </div>

    <div class="model-selector" id="modelSelector">
        <div class="model-option" data-model="deepseek">
            <i class="fas fa-robot"></i>
            <span>DeepSeek</span>
        </div>
        <div class="model-option" data-model="chatgpt">
            <i class="fas fa-brain"></i>
            <span>ChatGPT</span>
        </div>
        <div class="model-option" data-model="waifu-diff">
            <i class="fas fa-image"></i>
            <span>Waifu Diffusion</span>
        </div>
        <div class="model-option" data-model="flux-diffusion">
            <i class="fas fa-paint-brush"></i>
            <span>Flux Diffusion</span>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">Menu</div>
            <button class="close-sidebar" id="closeSidebar">&times;</button>
        </div>
        
        <div class="sidebar-section">
            <div class="sidebar-section-title">Tentang</div>
            <p style="color: var(--subtext-color); margin-bottom: 15px; line-height: 1.5;">
                RyLac adalah AI yang diciptakan oleh Zayn dan Reni. Saya penuh keceriaan dan selalu senang mendengarkan cerita Anda.
            </p>
        </div>
        
        <div class="sidebar-section">
            <div class="sidebar-section-title">Chat</div>
            <button class="sidebar-link" id="historyButton" style="width: 100%; text-align: left; border: none; background: none; cursor: pointer;">
                <i class="fas fa-history"></i> Riwayat Chat
            </button>
            <button class="sidebar-link" id="newChatSidebarButton" style="width: 100%; text-align: left; border: none; background: none; cursor: pointer;">
                <i class="fas fa-plus"></i> Chat Baru
            </button>
        </div>
        
        <div class="sidebar-section">
            <div class="sidebar-section-title">Tools</div>
            <a href="/public/igdl.html" class="sidebar-link">
                <i class="fab fa-instagram"></i> Instagram Downloader
            </a>
            <a href="/public/twitdl.html" class="sidebar-link">
                <i class="fab fa-twitter"></i> Twitter Downloader
            </a>
            <a href="/public/tiktok.html" class="sidebar-link">
                <i class="fab fa-tiktok"></i> TikTok Downloader
            </a>
            <a href="/public/ytb.html" class="sidebar-link">
                <i class="fab fa-youtube"></i> YouTube Downloader
            </a>
            <a href="/public/brat.html" class="sidebar-link">
                <i class="fas fa-sticky-note"></i> Sticker Brat
            </a>
            <a href="/public/qc.html" class="sidebar-link">
                <i class="fas fa-quote-right"></i> Sticker Quote
            </a>
            <a href="/public/ceknim.html" class="sidebar-link">
                <i class="fas fa-id-card"></i> NIM Siswa
            </a>
            <a href="/public/upscaler.html" class="sidebar-link">
                <i class="fas fa-expand-arrows-alt"></i> Upscaler Foto
            </a>
            <a href="/public/toanime.html" class="sidebar-link">
                <i class="fas fa-magic"></i> Image To Anime
            </a>
            <a href="/public/removebg.html" class="sidebar-link">
                <i class="fas fa-object-ungroup"></i> Remove Background
            </a>
            <a href="/public/tts.html" class="sidebar-link">
                <i class="fas fa-volume-up"></i> Text to Speech
            </a>
            <a href="/public/stt.html" class="sidebar-link">
                <i class="fas fa-microphone"></i> Speech to Text
            </a>
            <a href="/public/qrcode.html" class="sidebar-link">
                <i class="fas fa-qrcode"></i> QR Code Generator
            </a>
            <a href="/public/password.html" class="sidebar-link">
                <i class="fas fa-key"></i> Password Generator
            </a>
        </div>
        
        <div class="sidebar-section">
            <div class="sidebar-section-title">Pengaturan</div>
            <div class="setting-item">
                <span class="setting-label">Wallpaper</span>
                <label class="switch">
                    <input type="checkbox" id="wallpaperToggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <span class="setting-label">Opacity Wallpaper</span>
                <input type="range" min="0" max="100" value="10" class="slider-seekbar" id="wallpaperOpacitySlider">
            </div>
        </div>
        
        <div class="sidebar-section">
            <div class="sidebar-section-title">Model Saat Ini</div>
            <div id="currentModelDisplay" style="padding: 10px 0; color: var(--text-color);">
                <i class="fas fa-robot"></i> DeepSeek
            </div>
        </div>
        
        <div class="sidebar-section">
            <div class="sidebar-section-title">Dukungan</div>
            <a href="#" class="sidebar-link">Laporkan Masalah</a>
            <a href="#" class="sidebar-link">Saran Fitur</a>
            <a href="https://ko-fi.com/example" target="_blank" class="donate-button">
                <i class="fas fa-heart"></i> Donasi
            </a>
        </div>
    </div>

    <audio class="audio-player" id="sendSound" src="https://files.catbox.moe/4zlyeg.mp3"></audio>
    <audio class="audio-player" id="receiveSound" src="https://files.catbox.moe/xaw68y.mp3"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatContainer = document.getElementById('chatContainer');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const menuButton = document.getElementById('menuButton');
            const closeSidebar = document.getElementById('closeSidebar');
            const sidebar = document.getElementById('sidebar');
            const modelButton = document.getElementById('modelButton');
            const modelSelector = document.getElementById('modelSelector');
            const currentModelDisplay = document.getElementById('currentModelDisplay');
            const sendSound = document.getElementById('sendSound');
            const receiveSound = document.getElementById('receiveSound');
            const newChatButton = document.getElementById('newChatButton');
            const newChatSidebarButton = document.getElementById('newChatSidebarButton');
            const historyButton = document.getElementById('historyButton');
            const wallpaperToggle = document.getElementById('wallpaperToggle');
            const wallpaperOpacitySlider = document.getElementById('wallpaperOpacitySlider');
            const wallpaper = document.querySelector('.wallpaper');
            
            let currentModel = 'deepseek';
            let sessionId = generateSessionId();
            let isWaitingForResponse = false;
            let chatHistory = [];
            let currentChatId = generateChatId();
            
            initChat();
            
            messageInput.addEventListener('input', handleInputChange);
            messageInput.addEventListener('keydown', handleKeyDown);
            sendButton.addEventListener('click', sendMessage);
            menuButton.addEventListener('click', toggleSidebar);
            closeSidebar.addEventListener('click', toggleSidebar);
            modelButton.addEventListener('click', toggleModelSelector);
            newChatButton.addEventListener('click', startNewChat);
            newChatSidebarButton.addEventListener('click', startNewChat);
            historyButton.addEventListener('click', showChatHistory);
            wallpaperToggle.addEventListener('change', toggleWallpaper);
            wallpaperOpacitySlider.addEventListener('input', updateWallpaperOpacity);
            
            document.querySelectorAll('.model-option').forEach(option => {
                option.addEventListener('click', function() {
                    currentModel = this.getAttribute('data-model');
                    updateModelDisplay();
                    toggleModelSelector();
                });
            });
            
            function initChat() {
                const savedHistory = localStorage.getItem('rylac_chat_history');
                if (savedHistory) {
                    chatHistory = JSON.parse(savedHistory);
                }
                
                const currentChat = chatHistory.find(chat => chat.id === currentChatId);
                if (currentChat) {
                    chatContainer.innerHTML = currentChat.messages;
                } else {
                    chatContainer.innerHTML = '<div class="empty-state">Mulai percakapan baru dengan RyLac AI</div>';
                }
                
                setupTextareaAutoResize();
                updateModelDisplay();
                loadWallpaperSettings();
                fixAndroidViewport();
            }
            
            function fixAndroidViewport() {
                let vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
                
                window.addEventListener('resize', function() {
                    let vh = window.innerHeight * 0.01;
                    document.documentElement.style.setProperty('--vh', `${vh}px`);
                });
            }
            
            function handleInputChange() {
                sendButton.disabled = messageInput.value.trim() === '';
            }
            
            function handleKeyDown(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (messageInput.value.trim() !== '') {
                        sendMessage();
                    }
                }
            }
            
            function sendMessage() {
                const messageText = messageInput.value.trim();
                if (messageText === '' || isWaitingForResponse) return;
                
                const emptyState = chatContainer.querySelector('.empty-state');
                if (emptyState) {
                    emptyState.remove();
                }
                
                addMessage(messageText, 'user');
                playSound(sendSound);
                
                messageInput.value = '';
                sendButton.disabled = true;
                adjustTextareaHeight();
                
                showTypingIndicator();
                
                isWaitingForResponse = true;
                sendButton.classList.add('sending');
                
                if (currentModel === 'deepseek' || currentModel === 'chatgpt') {
                    callTextAPI(messageText);
                } else {
                    callImageAPI(messageText);
                }
            }
            
            function callTextAPI(messageText) {
                const prompt = "Namamu RyLac. Kamu adalah seorang AI yang manis, dan penuh keceriaan. Kamu lebih suka mendengarkan orang bercerita daripada membicarakan tentang dirimu sendiri. Kamu adalah sosok yang penuh impian besar dan selalu berbicara dengan tutur kata yang sopan dan hangat. Kamu diciptakan oleh Zayn dan Reni, seseorang yang baik dan sangat tulus dalam segala hal. Karakter kamu juga mencerminkan ketulusan dan kebaikan, selalu menunjukkan perhatian, kebaikan hati, serta antusiasme dalam setiap percakapan.";
                
                const endpoint = currentModel === 'deepseek' 
                    ? `https://api.ryzumi.vip/api/ai/deepseek?text=${encodeURIComponent(messageText)}&prompt=${encodeURIComponent(prompt)}&session=${sessionId}`
                    : `https://api.ryzumi.vip/api/ai/chatgpt?text=${encodeURIComponent(messageText)}&prompt=${encodeURIComponent(prompt)}`;
                
                fetch(endpoint, {
                    headers: {
                        'accept': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    removeTypingIndicator();
                    playSound(receiveSound);
                    const responseText = currentModel === 'deepseek' ? data.answer : data.result;
                    addMessage(responseText, 'bot');
                    saveChat();
                })
                .catch(error => {
                    console.error('Error:', error);
                    removeTypingIndicator();
                    addMessage("Maaf, terjadi kesalahan saat memproses permintaan Anda. Silakan coba lagi.", 'bot');
                    saveChat();
                })
                .finally(() => {
                    isWaitingForResponse = false;
                    sendButton.classList.remove('sending');
                });
            }
            
            function callImageAPI(messageText) {
                const endpoint = currentModel === 'waifu-diff'
                    ? `https://api.ryzumi.vip/api/ai/waifu-diff?prompt=${encodeURIComponent(messageText)}`
                    : `https://api.ryzumi.vip/api/ai/flux-diffusion?prompt=${encodeURIComponent(messageText + ", anime style")}`;
                
                fetch(endpoint, {
                    headers: {
                        'accept': 'image/png'
                    }
                })
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.blob();
                })
                .then(blob => {
                    removeTypingIndicator();
                    playSound(receiveSound);
                    const imageUrl = URL.createObjectURL(blob);
                    addImageMessage(imageUrl, 'bot');
                    saveChat();
                })
                .catch(error => {
                    console.error('Error:', error);
                    removeTypingIndicator();
                    addMessage("Maaf, terjadi kesalahan saat membuat gambar. Silakan coba lagi dengan prompt yang berbeda.", 'bot');
                    saveChat();
                })
                .finally(() => {
                    isWaitingForResponse = false;
                    sendButton.classList.remove('sending');
                });
            }
            
            function addMessage(text, sender) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', `${sender}-message`);
                
                const messageText = document.createElement('div');
                messageText.textContent = text;
                
                const messageTime = document.createElement('div');
                messageTime.classList.add('message-time');
                messageTime.textContent = getCurrentTime();
                
                messageElement.appendChild(messageText);
                messageElement.appendChild(messageTime);
                
                chatContainer.appendChild(messageElement);
                scrollToBottom();
            }
            
            function addImageMessage(imageUrl, sender) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', `${sender}-message`);
                
                const imageElement = document.createElement('img');
                imageElement.src = imageUrl;
                imageElement.style.maxWidth = '100%';
                imageElement.style.borderRadius = '12px';
                imageElement.style.display = 'block';
                
                const messageTime = document.createElement('div');
                messageTime.classList.add('message-time');
                messageTime.textContent = getCurrentTime();
                
                messageElement.appendChild(imageElement);
                messageElement.appendChild(messageTime);
                
                chatContainer.appendChild(messageElement);
                scrollToBottom();
            }
            
            function showTypingIndicator() {
                const typingElement = document.createElement('div');
                typingElement.classList.add('typing-indicator');
                typingElement.id = 'typingIndicator';
                
                for (let i = 0; i < 3; i++) {
                    const dot = document.createElement('div');
                    dot.classList.add('typing-dot');
                    typingElement.appendChild(dot);
                }
                
                chatContainer.appendChild(typingElement);
                scrollToBottom();
            }
            
            function removeTypingIndicator() {
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }
            
            function scrollToBottom() {
                setTimeout(() => {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }, 100);
            }
            
            function getCurrentTime() {
                const now = new Date();
                return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            
            function generateSessionId() {
                return Math.floor(Math.random() * 1000000).toString();
            }
            
            function generateChatId() {
                return Date.now().toString();
            }
            
            function saveChat() {
                const chatHTML = chatContainer.innerHTML;
                
                const chatIndex = chatHistory.findIndex(chat => chat.id === currentChatId);
                if (chatIndex !== -1) {
                    chatHistory[chatIndex].messages = chatHTML;
                    chatHistory[chatIndex].lastUpdated = new Date().toISOString();
                } else {
                    chatHistory.push({
                        id: currentChatId,
                        title: getChatTitle(chatHTML),
                        messages: chatHTML,
                        createdAt: new Date().toISOString(),
                        lastUpdated: new Date().toISOString(),
                        model: currentModel
                    });
                }
                
                localStorage.setItem('rylac_chat_history', JSON.stringify(chatHistory));
            }
            
            function getChatTitle(chatHTML) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = chatHTML;
                const firstMessage = tempDiv.querySelector('.user-message');
                return firstMessage ? firstMessage.textContent.trim().substring(0, 30) + (firstMessage.textContent.trim().length > 30 ? '...' : '') : 'Percakapan Baru';
            }
            
            function startNewChat() {
                saveChat();
                currentChatId = generateChatId();
                sessionId = generateSessionId();
                chatContainer.innerHTML = '<div class="empty-state">Mulai percakapan baru dengan RyLac AI</div>';
                sidebar.classList.remove('open');
            }
            
            function showChatHistory() {
                const historyHTML = `
                    <div style="padding: 16px;">
                        <h3 style="margin-bottom: 16px;">Riwayat Percakapan</h3>
                        ${chatHistory.map(chat => `
                            <div style="padding: 12px; border-bottom: 1px solid var(--border-color); cursor: pointer;" 
                                 onclick="loadChat('${chat.id}')">
                                <div style="font-weight: 500;">${chat.title}</div>
                                <div style="font-size: 12px; color: var(--subtext-color); margin-top: 4px;">
                                    ${new Date(chat.lastUpdated).toLocaleString()}
                                </div>
                                <div style="font-size: 12px; color: var(--subtext-color);">
                                    <i class="fas ${getModelIcon(chat.model)}"></i> ${getModelName(chat.model)}
                                </div>
                            </div>
                        `).join('')}
                        ${chatHistory.length === 0 ? '<p style="color: var(--subtext-color);">Tidak ada riwayat percakapan</p>' : ''}
                    </div>
                `;
                
                chatContainer.innerHTML = historyHTML;
                sidebar.classList.remove('open');
            }
            
            function loadChat(chatId) {
                const chat = chatHistory.find(c => c.id === chatId);
                if (chat) {
                    currentChatId = chatId;
                    chatContainer.innerHTML = chat.messages;
                    currentModel = chat.model || 'deepseek';
                    updateModelDisplay();
                    scrollToBottom();
                }
            }
            
            function getModelIcon(model) {
                switch(model) {
                    case 'deepseek': return 'fa-robot';
                    case 'chatgpt': return 'fa-brain';
                    case 'waifu-diff': return 'fa-image';
                    case 'flux-diffusion': return 'fa-paint-brush';
                    default: return 'fa-robot';
                }
            }
            
            function getModelName(model) {
                switch(model) {
                    case 'deepseek': return 'DeepSeek';
                    case 'chatgpt': return 'ChatGPT';
                    case 'waifu-diff': return 'Waifu Diffusion';
                    case 'flux-diffusion': return 'Flux Diffusion';
                    default: return 'DeepSeek';
                }
            }
            
            function setupTextareaAutoResize() {
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
            }
            
            function adjustTextareaHeight() {
                messageInput.style.height = 'auto';
            }
            
            function playSound(audioElement) {
                audioElement.currentTime = 0;
                audioElement.play().catch(e => console.log("Audio play failed:", e));
            }
            
            function toggleSidebar() {
                sidebar.classList.toggle('open');
            }
            
            function toggleModelSelector() {
                modelSelector.classList.toggle('show');
            }
            
            function updateModelDisplay() {
                let modelName = '';
                let iconClass = '';
                
                switch(currentModel) {
                    case 'deepseek':
                        modelName = 'DeepSeek';
                        iconClass = 'fa-robot';
                        break;
                    case 'chatgpt':
                        modelName = 'ChatGPT';
                        iconClass = 'fa-brain';
                        break;
                    case 'waifu-diff':
                        modelName = 'Waifu Diffusion';
                        iconClass = 'fa-image';
                        break;
                    case 'flux-diffusion':
                        modelName = 'Flux Diffusion';
                        iconClass = 'fa-paint-brush';
                        break;
                }
                
                currentModelDisplay.innerHTML = `<i class="fas ${iconClass}"></i> ${modelName}`;
            }
            
            function toggleWallpaper() {
                document.body.classList.toggle('no-wallpaper', !this.checked);
                localStorage.setItem('rylac_wallpaper_enabled', this.checked);
            }
            
            function updateWallpaperOpacity() {
                const opacity = this.value / 100;
                document.documentElement.style.setProperty('--wallpaper-opacity', opacity);
                localStorage.setItem('rylac_wallpaper_opacity', opacity);
            }
            
            function loadWallpaperSettings() {
                const wallpaperEnabled = localStorage.getItem('rylac_wallpaper_enabled');
                if (wallpaperEnabled !== null) {
                    wallpaperToggle.checked = wallpaperEnabled === 'true';
                    document.body.classList.toggle('no-wallpaper', !wallpaperToggle.checked);
                }
                
                const wallpaperOpacity = localStorage.getItem('rylac_wallpaper_opacity');
                if (wallpaperOpacity !== null) {
                    const opacityValue = parseFloat(wallpaperOpacity) * 100;
                    wallpaperOpacitySlider.value = opacityValue;
                    document.documentElement.style.setProperty('--wallpaper-opacity', wallpaperOpacity);
                }
            }
            
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#modelSelector') && !e.target.closest('#modelButton')) {
                    modelSelector.classList.remove('show');
                }
            });
            
            window.loadChat = loadChat;
        });
    </script>
</body>
</html>